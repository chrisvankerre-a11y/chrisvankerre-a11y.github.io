<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tableau interne (priv√© ‚Äì √©dition & suppression)</title>
  <style>
    body{font-family:system-ui,sans-serif;background:#0f172a;color:#f8fafc;margin:0;padding:24px;line-height:1.5}
    h1,h2{text-align:center;color:#a5b4fc;margin-bottom:20px}
    section{margin-bottom:48px;border:1px solid #1e293b;border-radius:10px;background:rgba(255,255,255,.03);padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.95rem}
    th,td{border:1px solid #1e293b;padding:8px 10px;text-align:left;vertical-align:top}
    th{background:#1e293b;color:#a5b4fc;text-transform:uppercase;font-size:.85rem}
    tr:nth-child(even){background:#1e293b44}
    .loading{text-align:center;margin-top:20px;color:#94a3b8}
    .topbar{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-bottom:12px}
    .btn{padding:8px 14px;border:none;border-radius:8px;cursor:pointer}
    .btn.clear{background:#7c3aed;color:#fff}
    .btn.delete{background:#dc2626;color:#fff}
    #passwordBox{text-align:center;margin:40px 0} input[type=password]{padding:10px;border-radius:8px;border:none}
    td[contenteditable="true"]{outline:1px dashed #64748b}
    .actions{text-wrap:nowrap}
    /* aide visuelle et clics sur liens */
    a{ text-decoration: underline; }
  </style>
</head>
<body>
  <h1>üîê Tableau interne ‚Äì Administration</h1>

  <div id="passwordBox">
    <p>Veuillez entrer le mot de passe :</p>
    <input type="password" id="pass" placeholder="Mot de passe" />
    <button class="btn" onclick="checkPass()">Valider</button>
    <div id="error" style="color:#f87171;margin-top:10px;"></div>
  </div>

  <div id="content" style="display:none;">
    <div class="topbar">
      <h2>üßæ Entr√©es (entries)</h2>
      <button class="btn clear" onclick="clearAll()">üóëÔ∏è Tout effacer</button>
    </div>

    <!-- 1) DIVERS -->
    <section id="diversSection" style="display:none;">
      <h2>üóíÔ∏è Communications (Divers)</h2>
      <table>
        <thead><tr><th>D√©partement</th><th>Message</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="diversBody"></tbody>
      </table>
    </section>

    <!-- 2) NEWS -->
    <section id="newsSection" style="display:none;">
      <h2>üÜï News par d√©partement</h2>
      <table>
        <thead><tr><th>D√©partement</th><th>Titre</th><th>Description</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="newsBody"></tbody>
      </table>
    </section>

    <!-- 3) √âV√âNEMENTS -->
    <section id="eventsSection" style="display:none;">
      <h2>üìÖ √âv√©nements class√©s par date</h2>
      <table>
        <thead><tr><th>Date</th><th>D√©partement</th><th>Titre</th><th>Description</th><th>Actions</th></tr></thead>
        <tbody id="eventsBody"></tbody>
      </table>
    </section>

    <div id="loading" class="loading">Chargement des donn√©es...</div>
  </div>

  <script>
    const PASSWORD='Namur2025';
    const SUPABASE_URL='https://isauxospdiokshswavyk.supabase.co';
    const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzYXV4b3NwZGlva3Noc3dhdnlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNDY5ODYsImV4cCI6MjA3NjkyMjk4Nn0.UwVcD_DfqfjsBiZgffg_EpAXxt63qzlZC1d_j4zwsQ8';
    const BASE=`${SUPABASE_URL}/rest/v1/entries`;
    const H={apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`};

    /* ========= utils ========= */
    const escapeHTML = (s='') => s
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');

    /** Transforme du texte en HTML avec URLs cliquables.
     *  - Si la cha√Æne contient d√©j√† <a ...>, on la garde telle quelle.
     *  - Sinon on √©chappe, puis on ‚Äúlinkifie‚Äù.
     */
    function linkify(text=''){
      if (text.includes('<a ')) return text; // on fait confiance si balise d√©j√† fournie
      const escaped = escapeHTML(text);
      const urlRe = /(https?:\/\/[^\s)]+)|(\bwww\.[^\s)]+)/gi;
      return escaped.replace(urlRe, (m) => {
        const href = m.startsWith('http') ? m : `https://${m}`;
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${m}</a>`;
      });
    }

    const fmtDate = d => { try{ return new Date(d||'').toLocaleString('fr-BE'); } catch { return d||''; } };
    const cmpAsc  = (a,b) => new Date(a.date||a.created_at)-new Date(b.date||b.created_at);
    const cmpDeptThenDate = (a,b) => {
      const c=(a.departement||'').localeCompare(b.departement||'');
      return c!==0 ? c : new Date(b.date||b.created_at)-new Date(a.date||a.created_at);
    };

    function checkPass(){
      const input=document.getElementById('pass').value.trim();
      if(input===PASSWORD){ document.getElementById('passwordBox').style.display='none'; document.getElementById('content').style.display='block'; loadAll(); }
      else{ document.getElementById('error').textContent='Mot de passe incorrect.'; }
    }

    async function loadAll(){
      const r=await fetch(BASE+'?select=*&order=date.nullsfirst,created_at.desc',{headers:H});
      if(!r.ok){ document.getElementById('loading').textContent='‚ùå Erreur de chargement'; return; }
      const rows=await r.json(); render(rows);
    }

    function render(rows){
      const diversBody=document.getElementById('diversBody');
      const newsBody=document.getElementById('newsBody');
      const eventsBody=document.getElementById('eventsBody');
      diversBody.innerHTML=newsBody.innerHTML=eventsBody.innerHTML='';

      // 1) DIVERS
      rows.filter(e=>e.type==='divers').forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td contenteditable="true" data-id="${e.id}" data-field="departement">${escapeHTML(e.departement||'')}</td>
          <td contenteditable="true" data-id="${e.id}" data-field="content">${linkify(e.content||'')}</td>
          <td contenteditable="true" data-id="${e.id}" data-field="date">${escapeHTML(e.date||'')}</td>
          <td class="actions"><button class="btn delete" onclick="deleteEntry(${e.id})">Supprimer</button></td>`;
        attachEditors(tr); diversBody.appendChild(tr);
      });

      // 2) NEWS
      rows.filter(e=>e.type==='news').sort(cmpDeptThenDate).forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td contenteditable="true" data-id="${e.id}" data-field="departement">${escapeHTML(e.departement||'')}</td>
          <td contenteditable="true" data-id="${e.id}" data-field="title">${escapeHTML(e.title||'')}</td>
          <td contenteditable="true" data-id="${e.id}" data-field="content">${linkify(e.content||'')}</td>
          <td contenteditable="true" data-id="${e.id}" data-field="date">${escapeHTML(e.date||'')}</td>
          <td class="actions"><button class="btn delete" onclick="deleteEntry(${e.id})">Supprimer</button></td>`;
        attachEditors(tr); newsBody.appendChild(tr);
      });

      // 3) √âV√âNEMENTS
      rows.filter(e=>e.type==='event').sort(cmpAsc).forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td contenteditable="true" data-id="${e.id}" data-field="date">${escapeHTML(e.date||'')}</td>
          <td contenteditable="true" data-id="${e.id}" data-field="departement">${escapeHTML(e.departement||'')}</td>
          <td contenteditable="true" data-id="${e.id}" data-field="title">${escapeHTML(e.title||'')}</td>
          <td contenteditable="true" data-id="${e.id}" data-field="content">${linkify(e.content||'')}</td>
          <td class="actions"><button class="btn delete" onclick="deleteEntry(${e.id})">Supprimer</button></td>`;
        attachEditors(tr); eventsBody.appendChild(tr);
      });

      document.getElementById('diversSection').style.display = diversBody.children.length ? 'block' : 'none';
      document.getElementById('newsSection').style.display   = newsBody.children.length   ? 'block' : 'none';
      document.getElementById('eventsSection').style.display = eventsBody.children.length ? 'block' : 'none';
      document.getElementById('loading').style.display='none';
    }

    function attachEditors(tr){
      tr.querySelectorAll('[contenteditable]').forEach(cell=>{
        // Ouvrir les liens en clic, m√™me dans une cellule √©ditable
        cell.addEventListener('click', (e)=>{
          const a = e.target.closest('a');
          if(a){
            e.preventDefault(); e.stopPropagation();
            window.open(a.href, '_blank', 'noopener');
          }
        });
        // Enregistrer au blur ou Enter
        cell.addEventListener('blur', ()=> saveCell(cell));
        cell.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); cell.blur(); } });
      });
    }

    async function saveCell(cell){
      const id=cell.dataset.id; const field=cell.dataset.field;
      // On enregistre toujours du texte brut (les liens seront re-linkifi√©s √† l‚Äôaffichage)
      const value=cell.innerText.trim();
      const r=await fetch(`${BASE}?id=eq.${id}`,{
        method:'PATCH',
        headers:{...H,'Content-Type':'application/json'},
        body: JSON.stringify({ [field]: value })
      });
      if(!r.ok){ alert('‚ùå Erreur de mise √† jour'); return; }
      if(field==='date'){ loadAll(); } // re-tri si la date change
    }

    async function deleteEntry(id){
      if(!confirm(`Supprimer la ligne #${id} ?`)) return;
      const r=await fetch(`${BASE}?id=eq.${id}`,{ method:'DELETE', headers:H });
      if(r.ok){ loadAll(); } else { alert('‚ùå Erreur lors de la suppression'); }
    }

    async function clearAll(){
      if(!confirm('‚ö†Ô∏è Supprimer TOUTES les entr√©es ?')) return;
      try {
        const r = await fetch(BASE + '?id=gt.0', {
          method: 'DELETE',
          headers: H
        });
        if (!r.ok) {
          const txt = await r.text();
          alert('‚ùå Erreur lors de la r√©initialisation : ' + (txt || r.status));
          return;
        }
        alert('‚úÖ Toutes les entr√©es ont √©t√© supprim√©es.');
        loadAll();
      } catch (e) {
        alert('‚ùå Erreur r√©seau : ' + (e.message || 'inconnue'));
      }
    }
  </script>
</body>
</html>
