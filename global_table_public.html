<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tableau des communications (publique)</title>
  <style>
    body{font-family:system-ui,sans-serif;background:#0f172a;color:#f8fafc;margin:0;padding:24px;line-height:1.5}
    h1,h2{text-align:center;color:#a5b4fc;margin-bottom:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;max-width:1100px;margin:0 auto 16px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid #1e293b;background:#0b1220;color:#f8fafc;padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none}
    .btn.primary{background:#16a34a;border-color:#16a34a;color:#04120b;font-weight:600}
    section{margin-bottom:48px;border:1px solid #1e293b;border-radius:10px;background:rgba(255,255,255,.03);padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.95rem}
    th,td{border:1px solid #1e293b;padding:8px 10px;text-align:left;vertical-align:top;position:relative}
    th{background:#1e293b;color:#a5b4fc;text-transform:uppercase;font-size:.85rem}
    tr:nth-child(even){background:#1e293b44}
    .loading{text-align:center;margin-top:40px;color:#94a3b8}
    /* liens robustes */
    a{ text-decoration: underline; pointer-events: auto !important; position: relative; z-index: 2; cursor: pointer; }
    td a{ position: relative; z-index: 2; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>üìä Tableau des communications</h1>
    <!-- üëá Lien ajout√© vers le canevas infos -->
    <a class="btn primary" href="./dept_form_supabase01.html" target="_blank" rel="noopener noreferrer">‚ûï Ajouter des infos</a>
  </div>

  <div id="loading" class="loading">Chargement des donn√©es...</div>

  <!-- 1) DIVERS -->
  <section id="diversSection" style="display:none;">
    <h2>üóíÔ∏è Communications (Divers)</h2>
    <table>
      <thead><tr><th>D√©partement</th><th>Message</th><th>Date</th></tr></thead>
      <tbody id="diversBody"></tbody>
    </table>
  </section>

  <!-- 2) NEWS -->
  <section id="newsSection" style="display:none;">
    <h2>üÜï News par d√©partement</h2>
    <table>
      <thead><tr><th>D√©partement</th><th>Titre</th><th>Description</th><th>Date</th></tr></thead>
      <tbody id="newsBody"></tbody>
    </table>
  </section>

  <!-- 3) √âV√âNEMENTS -->
  <section id="eventsSection" style="display:none;">
    <h2>üìÖ √âv√©nements class√©s par date</h2>
    <table>
      <thead><tr><th>Date</th><th>D√©partement</th><th>Titre</th><th>Description</th></tr></thead>
      <tbody id="eventsBody"></tbody>
    </table>
  </section>

  <script>
    const SUPABASE_URL='https://isauxospdiokshswavyk.supabase.co';
    const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzYXV4b3NwZGlva3Noc3dhdnlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNDY5ODYsImV4cCI6MjA3NjkyMjk4Nn0.UwVcD_DfqfjsBiZgffg_EpAXxt63qzlZC1d_j4zwsQ8';
    const BASE=`${SUPABASE_URL}/rest/v1/entries`;

    async function fetchEntries(){
      const r=await fetch(BASE+'?select=*&order=date.nullsfirst,created_at.desc',{
        headers:{apikey:SUPABASE_KEY,Authorization:'Bearer '+SUPABASE_KEY}
      });
      if(!r.ok) throw new Error('Erreur de connexion √† Supabase');
      return r.json();
    }

    const fmtDate = d => { try{ return new Date(d||'').toLocaleString('fr-BE'); } catch { return d||''; } };
    const cmpAsc  = (a,b) => new Date(a.date||a.created_at)-new Date(b.date||b.created_at);
    const cmpDeptThenDate = (a,b) => {
      const c=(a.departement||'').localeCompare(b.departement||'');
      return c!==0 ? c : new Date(b.date||b.created_at)-new Date(a.date||a.created_at);
    };

    /* ========= Rendu ‚Äúcliquable‚Äù & s√©curis√© ========= */
    const escapeHTML = (s='') => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    function linkify(text=''){
      if (text.includes('<a ')) return text;
      const escaped = escapeHTML(text);
      const urlRe = /(https?:\/\/[^\s)]+)|(\bwww\.[^\s)]+)/gi;
      return escaped.replace(urlRe, (m) => {
        const href = m.startsWith('http') ? m : `https://${m}`;
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${m}</a>`;
      });
    }

    function render(rows){
      const diversBody = document.getElementById('diversBody');
      const newsBody   = document.getElementById('newsBody');
      const eventsBody = document.getElementById('eventsBody');
      diversBody.innerHTML = newsBody.innerHTML = eventsBody.innerHTML = '';

      // 1) Divers
      rows.filter(e=>e.type==='divers').forEach(e=>{
        const tr=document.createElement('tr');
        const tdDept=document.createElement('td'); tdDept.textContent = e.departement||'';
        const tdMsg=document.createElement('td');  tdMsg.innerHTML = linkify(e.content||'');
        const tdDate=document.createElement('td'); tdDate.textContent = fmtDate(e.date||e.created_at);
        tr.append(tdDept, tdMsg, tdDate); diversBody.appendChild(tr);
      });

      // 2) News
      rows.filter(e=>e.type==='news').sort(cmpDeptThenDate).forEach(e=>{
        const tr=document.createElement('tr');
        const tdDept=document.createElement('td');  tdDept.textContent = e.departement||'';
        const tdTitle=document.createElement('td'); tdTitle.textContent = e.title||'';
        const tdDesc=document.createElement('td');  tdDesc.innerHTML  = linkify(e.content||'');
        const tdDate=document.createElement('td');  tdDate.textContent = fmtDate(e.date||e.created_at);
        tr.append(tdDept, tdTitle, tdDesc, tdDate); newsBody.appendChild(tr);
      });

      // 3) √âv√©nements
      rows.filter(e=>e.type==='event').sort(cmpAsc).forEach(e=>{
        const tr=document.createElement('tr');
        const tdDate=document.createElement('td');  tdDate.textContent = fmtDate(e.date||e.created_at);
        const tdDept=document.createElement('td');  tdDept.textContent = e.departement||'';
        const tdTitle=document.createElement('td'); tdTitle.textContent = e.title||'';
        const tdDesc=document.createElement('td');  tdDesc.innerHTML  = linkify(e.content||'');
        tr.append(tdDate, tdDept, tdTitle, tdDesc); eventsBody.appendChild(tr);
      });

      document.getElementById('diversSection').style.display = diversBody.children.length ? 'block' : 'none';
      document.getElementById('newsSection').style.display   = newsBody.children.length   ? 'block' : 'none';
      document.getElementById('eventsSection').style.display = eventsBody.children.length ? 'block' : 'none';
      document.getElementById('loading').style.display='none';
    }

    // Gestionnaire GLOBAL (capture) : liens toujours cliquables
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a');
      if (!a) return;
      const inTables = a.closest('#diversSection, #newsSection, #eventsSection');
      if (!inTables) return;
      e.preventDefault();
      e.stopPropagation();
      if (e.isTrusted) window.open(a.href, '_blank', 'noopener');
    }, true);

    // Init
    fetchEntries().then(render).catch(err=>{
      document.getElementById('loading').textContent='‚ùå '+err.message;
    });
  </script>
</body>
</html>
